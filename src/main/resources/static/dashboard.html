<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Streamflix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-enter-active { opacity: 1; transition: opacity 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-neutral-900 text-white font-sans">

<nav class="flex justify-between items-center px-10 py-4 bg-gradient-to-b from-black/90 to-transparent fixed w-full z-50 transition duration-500" id="navbar">
    <div class="flex items-center gap-8">
        <div class="text-3xl font-bold text-red-600 cursor-pointer" onclick="location.reload()">STREAMFLIX</div>
        <a href="#" class="text-white font-bold hidden md:block">Home</a>
        <a href="history.html" class="text-gray-300 hover:text-white transition hidden md:block">History</a>
    </div>

    <div class="flex items-center gap-4">
        <div class="relative">
            <input type="text" id="search-input" onkeyup="filterMovies()" placeholder="Titles, people, genres"
                   class="bg-black/50 border border-gray-500 text-white px-3 py-1 rounded transition focus:outline-none focus:border-white w-0 md:w-64 opacity-0 md:opacity-100 focus:w-64 focus:opacity-100">
        </div>
        <button onclick="logout()" class="text-sm bg-red-600 px-4 py-1 rounded hover:bg-red-700">Sign Out</button>
    </div>
</nav>

<div id="hero-slider" class="relative h-[70vh] w-full overflow-hidden group">
    <div id="hero-content" class="absolute top-0 left-0 w-full h-full"></div>

    <div class="absolute inset-0 bg-gradient-to-t from-neutral-900 via-transparent to-black/30 pointer-events-none"></div>

    <button onclick="prevSlide()" class="absolute left-0 top-0 bottom-0 z-40 w-16 flex items-center justify-center text-white/50 hover:text-white hover:bg-black/20 transition duration-300">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
    </button>

    <button onclick="nextSlide()" class="absolute right-0 top-0 bottom-0 z-40 w-16 flex items-center justify-center text-white/50 hover:text-white hover:bg-black/20 transition duration-300">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
    </button>

    <div class="absolute bottom-20 left-10 z-20 max-w-xl pointer-events-none">
        <h1 id="hero-title" class="text-5xl font-bold mb-4 drop-shadow-lg transition-all duration-500">Loading...</h1>
        <p id="hero-desc" class="text-lg mb-6 drop-shadow-md text-gray-200 line-clamp-3 transition-all duration-500"></p>
        <div class="flex gap-4 pointer-events-auto">
            <button id="hero-play-btn" class="bg-white text-black px-8 py-2 rounded font-bold hover:bg-gray-200 flex items-center gap-2">
                <span>â–¶</span> Play
            </button>
        </div>
    </div>
</div>

<div class="px-10 py-8 -mt-16 relative z-30">
    <h2 class="text-xl font-bold mb-4">Trending Now</h2>
    <div id="movie-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
    </div>
    <p id="no-results" class="hidden text-gray-500 text-center mt-10">No movies found matching your search.</p>
</div>

<div id="video-modal" class="fixed inset-0 bg-black/95 z-[60] hidden flex items-center justify-center">
    <div class="relative w-full max-w-5xl px-4">
        <button onclick="closePlayer()" class="absolute -top-10 right-4 text-white text-3xl font-bold hover:text-red-600">&times;</button>
        <div id="player-container" class="aspect-video bg-black shadow-2xl rounded-lg overflow-hidden border border-gray-800"></div>
    </div>
</div>
<div class="px-10 mb-6 overflow-x-auto whitespace-nowrap">
    <button onclick="filterMovies('All')" class="category-btn bg-red-600 text-white px-4 py-1 rounded-full text-sm font-bold mr-2 hover:bg-red-700 transition">All</button>
    <button onclick="filterMovies('Action')" class="category-btn bg-gray-800 text-gray-300 px-4 py-1 rounded-full text-sm font-bold mr-2 hover:bg-gray-700 transition">Action</button>
    <button onclick="filterMovies('Comedy')" class="category-btn bg-gray-800 text-gray-300 px-4 py-1 rounded-full text-sm font-bold mr-2 hover:bg-gray-700 transition">Comedy</button>
    <button onclick="filterMovies('Sci-Fi')" class="category-btn bg-gray-800 text-gray-300 px-4 py-1 rounded-full text-sm font-bold mr-2 hover:bg-gray-700 transition">Sci-Fi</button>
    <button onclick="filterMovies('Horror')" class="category-btn bg-gray-800 text-gray-300 px-4 py-1 rounded-full text-sm font-bold mr-2 hover:bg-gray-700 transition">Horror</button>
    <button onclick="filterMovies('Romance')" class="category-btn bg-gray-800 text-gray-300 px-4 py-1 rounded-full text-sm font-bold mr-2 hover:bg-gray-700 transition">Romance</button>
</div>
<script>
    if(!localStorage.getItem('userEmail')) window.location.href = 'index.html';

    let allMovies = [];
    let featuredMovies = [];
    let currentSlideIndex = 0;
    let slideTimer;

    async function init() {
        try {
            const res = await fetch('/api/movies');
            allMovies = await res.json();

            if (allMovies.length > 0) {
                // Take up to 5 movies for the slider
                featuredMovies = allMovies.slice(0, 5);
                renderGrid(allMovies);

                // Init Slider
                updateSlideUI(featuredMovies[0]);
                startSlideTimer();
            } else {
                document.getElementById('hero-title').innerText = "No Movies Available";
            }
        } catch (e) {
            console.error("Failed to load movies", e);
        }
    }

    // --- SLIDER LOGIC ---
    function updateSlideUI(movie) {
        const hero = document.getElementById('hero-content');
        const title = document.getElementById('hero-title');
        const desc = document.getElementById('hero-desc');
        const playBtn = document.getElementById('hero-play-btn');

        // Set background
        hero.innerHTML = `
                <div class="w-full h-full bg-cover bg-center transition-opacity duration-700 ease-in-out"
                     style="background-image: url('${movie.thumbnailUrl}');">
                </div>
            `;

        title.innerText = movie.title;
        desc.innerText = movie.description || "Watch this amazing title now on Streamflix. Experience the drama, action, and suspense.";
        playBtn.onclick = () => playMovie(movie);
    }

    function nextSlide() {
        if (featuredMovies.length === 0) return;
        currentSlideIndex = (currentSlideIndex + 1) % featuredMovies.length;
        updateSlideUI(featuredMovies[currentSlideIndex]);
        resetSlideTimer();
    }

    function prevSlide() {
        if (featuredMovies.length === 0) return;
        currentSlideIndex = (currentSlideIndex - 1 + featuredMovies.length) % featuredMovies.length;
        updateSlideUI(featuredMovies[currentSlideIndex]);
        resetSlideTimer();
    }

    function startSlideTimer() {
        slideTimer = setInterval(() => {
            nextSlide();
        }, 5000);
    }

    function resetSlideTimer() {
        clearInterval(slideTimer);
        startSlideTimer();
    }

    // --- SEARCH LOGIC ---
    function filterMovies() {
        const query = document.getElementById('search-input').value.toLowerCase();
        const filtered = allMovies.filter(m => m.title.toLowerCase().includes(query));
        renderGrid(filtered);

        const slider = document.getElementById('hero-slider');
        const noResults = document.getElementById('no-results');

        if (query.length > 0) {
            slider.classList.add('hidden');
            noResults.classList.toggle('hidden', filtered.length > 0);
        } else {
            slider.classList.remove('hidden');
            noResults.classList.add('hidden');
        }
    }

    function renderGrid(movies) {
        const grid = document.getElementById('movie-grid');
        grid.innerHTML = movies.map(movie => `
                <div onclick='playMovie(${JSON.stringify(movie)})' class="relative group cursor-pointer transition transform hover:scale-105">
                    <img src="${movie.thumbnailUrl}" class="rounded-md w-full h-40 object-cover" alt="${movie.title}">
                    <div class="mt-2">
                        <h3 class="font-bold text-sm text-gray-200 group-hover:text-white">${movie.title}</h3>
                    </div>
                </div>
            `).join('');
    }

    // --- PLAYER & HISTORY ---
    function playMovie(movie) {
        addToHistory(movie);
        const modal = document.getElementById('video-modal');
        const container = document.getElementById('player-container');
        let url = movie.videoUrl;

        // Clean up the container first
        container.innerHTML = '';

        // 1. YouTube links
        if (url.includes('youtube') || url.includes('youtu.be')) {
            const videoId = url.split('v=')[1] || url.split('/').pop();
            const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
            container.innerHTML = `<iframe src="${embedUrl}" class="w-full h-full" frameborder="0" allowfullscreen></iframe>`;
        }
        // 2. Google Drive links (The fix)
        else if (url.includes('drive.google.com')) {
            // We have to swap '/view' with '/preview' to make it embeddable
            // otherwise Google blocks it from playing inside other apps
            const embedUrl = url.replace(/\/view.*/, '/preview');
            container.innerHTML = `<iframe src="${embedUrl}" class="w-full h-full" style="border:none;" allow="autoplay"></iframe>`;
        }
        // 3. Direct files (Cloudinary, MP4s, etc)
        else {
            container.innerHTML = `<video controls autoplay class="w-full h-full"><source src="${url}" type="video/mp4"></video>`;
        }

        modal.classList.remove('hidden');
    }

    function addToHistory(movie) {
        let history = JSON.parse(localStorage.getItem('watchHistory')) || [];
        history = history.filter(m => m.id !== movie.id);
        history.push(movie);
        if(history.length > 20) history.shift();
        localStorage.setItem('watchHistory', JSON.stringify(history));
    }

    function closePlayer() {
        document.getElementById('video-modal').classList.add('hidden');
        document.getElementById('player-container').innerHTML = '';
    }

    function logout() { localStorage.clear(); window.location.href = 'index.html'; }

    window.onscroll = () => {
        const nav = document.getElementById('navbar');
        if (window.scrollY > 50) nav.classList.add('bg-black');
        else nav.classList.remove('bg-black');
    };

    init();

</script>
</body>
</html>
