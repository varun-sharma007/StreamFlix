<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>StreamFlix - Browse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Hide scrollbar for category list */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-black text-white font-sans">

<nav class="flex justify-between items-center px-10 py-5 bg-gradient-to-b from-black to-transparent sticky top-0 z-50">
    <div class="text-3xl font-bold text-red-600">STREAMFLIX</div>
    <div class="flex items-center gap-4">
        <span id="user-email" class="text-gray-300"></span>
        <button onclick="logout()" class="bg-red-600 px-4 py-1 rounded text-sm font-bold hover:bg-red-700">Sign Out</button>
    </div>
</nav>

<div class="px-10 mb-8">
    <h1 class="text-5xl font-bold mb-4">Unlimited movies, TV shows, and more.</h1>
    <p class="text-xl text-gray-300">Watch anywhere. Cancel anytime.</p>
</div>

<div class="px-10 mb-6 overflow-x-auto whitespace-nowrap no-scrollbar">
    <button onclick="filterMovies('All')" class="category-btn bg-red-600 text-white px-5 py-2 rounded-full text-sm font-bold mr-3 hover:bg-red-700 transition">All</button>
    <button onclick="filterMovies('Action')" class="category-btn bg-gray-800 text-gray-300 px-5 py-2 rounded-full text-sm font-bold mr-3 hover:bg-gray-700 transition">Action</button>
    <button onclick="filterMovies('Comedy')" class="category-btn bg-gray-800 text-gray-300 px-5 py-2 rounded-full text-sm font-bold mr-3 hover:bg-gray-700 transition">Comedy</button>
    <button onclick="filterMovies('Sci-Fi')" class="category-btn bg-gray-800 text-gray-300 px-5 py-2 rounded-full text-sm font-bold mr-3 hover:bg-gray-700 transition">Sci-Fi</button>
    <button onclick="filterMovies('Horror')" class="category-btn bg-gray-800 text-gray-300 px-5 py-2 rounded-full text-sm font-bold mr-3 hover:bg-gray-700 transition">Horror</button>
    <button onclick="filterMovies('Romance')" class="category-btn bg-gray-800 text-gray-300 px-5 py-2 rounded-full text-sm font-bold mr-3 hover:bg-gray-700 transition">Romance</button>
    <button onclick="filterMovies('Documentary')" class="category-btn bg-gray-800 text-gray-300 px-5 py-2 rounded-full text-sm font-bold mr-3 hover:bg-gray-700 transition">Documentary</button>
</div>

<div class="px-10 pb-20">
    <h2 class="text-xl font-bold mb-4 text-gray-400">Trending Now</h2>
    <div id="movie-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
    </div>
</div>

<div id="video-modal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex items-center justify-center">
    <div class="relative w-full max-w-5xl aspect-video bg-black rounded shadow-2xl">
        <button onclick="closeModal()" class="absolute -top-10 right-0 text-white text-3xl hover:text-red-500">&times;</button>
        <div id="player-container" class="w-full h-full flex items-center justify-center text-gray-500">
            Loading...
        </div>
    </div>
</div>

<script>
    // Auth Check
    const email = localStorage.getItem('userEmail');
    if(!email) window.location.href = 'index.html';
    document.getElementById('user-email').innerText = email;

    let allMovies = [];

    async function init() {
        try {
            const res = await fetch('/api/movies');
            allMovies = await res.json();
            renderMovies(allMovies);
        } catch (e) { console.error(e); }
    }

    function renderMovies(movies) {
        const grid = document.getElementById('movie-grid');
        if(movies.length === 0) {
            grid.innerHTML = '<p class="text-gray-500">No movies found in this category.</p>';
            return;
        }
        grid.innerHTML = movies.map(m => `
                <div onclick="playMovie(this)"
                     data-url="${m.videoUrl}"
                     class="group relative bg-gray-900 rounded overflow-hidden cursor-pointer hover:scale-105 transition-transform duration-300">
                    <img src="${m.thumbnailUrl}" class="w-full h-48 object-cover opacity-80 group-hover:opacity-100">
                    <div class="p-4">
                        <h3 class="font-bold text-lg truncate">${m.title}</h3>
                        <p class="text-xs text-gray-400 mt-1">${m.genre || 'General'}</p>
                    </div>
                </div>
            `).join('');
    }

    // Updated Render to handle passing data correctly
    function renderMovies(movies) {
        const grid = document.getElementById('movie-grid');
        if(movies.length === 0) {
            grid.innerHTML = '<p class="text-gray-500">No movies found in this category.</p>';
            return;
        }
        grid.innerHTML = movies.map(m => `
                <div onclick='playMovieById(${m.id})'
                     class="group relative bg-gray-900 rounded overflow-hidden cursor-pointer hover:scale-105 transition-transform duration-300">
                    <img src="${m.thumbnailUrl}" class="w-full h-48 object-cover opacity-80 group-hover:opacity-100">
                    <div class="p-4">
                        <h3 class="font-bold text-lg truncate">${m.title}</h3>
                        <p class="text-xs text-gray-400 mt-1">${m.genre || 'General'}</p>
                    </div>
                </div>
            `).join('');
    }

    function filterMovies(category) {
        // Update Buttons
        document.querySelectorAll('.category-btn').forEach(btn => {
            if(btn.innerText === category) {
                btn.classList.remove('bg-gray-800', 'text-gray-300');
                btn.classList.add('bg-red-600', 'text-white');
            } else {
                btn.classList.remove('bg-red-600', 'text-white');
                btn.classList.add('bg-gray-800', 'text-gray-300');
            }
        });

        // Filter Logic
        if (category === 'All') {
            renderMovies(allMovies);
        } else {
            const filtered = allMovies.filter(m => m.genre === category);
            renderMovies(filtered);
        }
    }

    function playMovieById(id) {
        const movie = allMovies.find(m => m.id === id);
        if(movie) playMovie(movie);
    }

    // --- SMART PLAYER LOGIC ---
    function playMovie(movie) {
        const modal = document.getElementById('video-modal');
        const container = document.getElementById('player-container');
        let url = movie.videoUrl;

        container.innerHTML = ''; // Clear previous

        // 1. YouTube
        if (url.includes('youtube') || url.includes('youtu.be')) {
            const videoId = url.split('v=')[1] || url.split('/').pop();
            const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
            container.innerHTML = `<iframe src="${embedUrl}" class="w-full h-full" frameborder="0" allowfullscreen></iframe>`;
        }
        // 2. Google Drive
        else if (url.includes('drive.google.com')) {
            const embedUrl = url.replace(/\/view.*/, '/preview');
            container.innerHTML = `<iframe src="${embedUrl}" class="w-full h-full" style="border:none;" allow="autoplay"></iframe>`;
        }
        // 3. Vimeo
        else if (url.includes('vimeo.com')) {
            const videoId = url.split('/').pop();
            const embedUrl = `https://player.vimeo.com/video/${videoId}?autoplay=1`;
            container.innerHTML = `<iframe src="${embedUrl}" class="w-full h-full" frameborder="0" allowfullscreen></iframe>`;
        }
        // 4. Direct File
        else {
            container.innerHTML = `<video controls autoplay class="w-full h-full"><source src="${url}" type="video/mp4"></video>`;
        }

        modal.classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('video-modal').classList.add('hidden');
        document.getElementById('player-container').innerHTML = ''; // Stop video
    }

    function logout() {
        localStorage.clear();
        window.location.href = 'index.html';
    }

    init();
</script>
</body>
</html>
